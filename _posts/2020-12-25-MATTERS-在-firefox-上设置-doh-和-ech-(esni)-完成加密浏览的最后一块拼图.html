---
layout: post
title: 在 Firefox 上设置 DoH 和 ECH (ESNI)，完成加密浏览的最后一块拼图
date: 2020-12-25 16:15:13.000000000 +00:00
link: https://matters.news/@outloudvi/%E5%9C%A8-firefox-%E4%B8%8A%E8%AE%BE%E7%BD%AE-do-h-%E5%92%8C-ech-esni-%E5%AE%8C%E6%88%90%E5%8A%A0%E5%AF%86%E6%B5%8F%E8%A7%88%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E5%9D%97%E6%8B%BC%E5%9B%BE-bafyreib4udbrzsi23jroh3oroxykys5ba4fiuongqqn6zwi4wctx2kdyum
categories: matters
tags: blog
author: Out65
---

<p>TLS 1.3 是 TLS 很大的一步。它新增的特性中相当令人瞩目的两个，一个是 <a href="https://blog.cloudflare.com/introducing-0-rtt/" target="_blank">0-RTT</a>，另一个就是随着 <code>KeyShareEntry</code> 的出现而变为现实的 ESNI (Encrypted SNI，现称 ECH，即 Encrypted Client Hello，下文将以 ECH 指代之）草案。这份草案目前已经有了八个版本（最新的在这里：<a href="https://tools.ietf.org/html/draft-ietf-tls-esni-08" target="_blank">draft-ietf-tls-esni-08</a>），也受部分浏览器（主要是 Firefox，Chromium <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=908132" target="_blank">似乎还不太想做</a>）以及部分服务商（主要是 CloudFlare）的支持。</p><p><a href="https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8D%E7%A7%B0%E6%8C%87%E7%A4%BA" target="_blank">SNI</a> (Server Name Indication) 主要用于同 IP 托管多个域名的情况。在这种情况下，客户端需要告知服务端其所访问的域名，服务端才能回复正确的证书，从而继续 TLS 握手过程。因此，虽然 TLS 使得用户的浏览内容和 HTTP 头都受到加密，第三方无法解密（如果你像 CNNIC 一样能<a href="https://blog.mozilla.org/security/2015/03/23/revoking-trust-in-one-cnnic-intermediate-certificate/comment-page-1/" target="_blank">用根证书做中间人攻击</a>，当我没说），但在访问使用了 SNI 的网站时，客户端告知域名的信息需要以明文的形式传递。这是一个鸡生蛋、蛋生鸡的问题：没有域名就无法发送证书，而没有证书就不能进行加密。此时，中间人便可以从 SNI 信息获取客户端所访问的域名，从而进行相应的处理（例如拦截）。这也是 SNI 封锁的原理。有了 ECH 的加持，HTTP 的整个过程就都被 TLS 等组件保护，变得全副武装。因此，也有人说 ECH 是加密浏览的最后一块拼图。</p><p><em>基于国家安全和网络主权原因，在某些国家和地区， ECH 已经全部被封锁。不过，不受此影响的用户可以继续往下看。</em></p><h2>那 ECH 的加密是怎么来的？</h2><p>没有 SNI，就没有服务器证书，那 ECH 考靠什么进行身份验证和加密呢？答案是 DNS。DoH (DNS over HTTPS) 和 DoT (DNS over TLS) 的广泛应用已经使 DNS 请求的机密性和完整性 (integrity) 得到了良好的保护。因此，在 DoH 和 DoT 下， DNS 可以被认为是安全和私密的。在这种背景下，近期的一个新草案 DNS SVCB 和 HTTPS RR (<code><a href="https://tools.ietf.org/html/draft-ietf-dnsop-svcb-https-01" target="_blank">draft-ietf-dnsop-svcb-https-01</a></code>) 推出了一些基于 DNS 进行查询的扩展。 ECH 就利用了这个扩展，通过 DNS 查询得到的信息和服务器建立加密信道。这两个草案蛮复杂的，这里就不展开讲了。</p><h2>上手 ECH</h2><h3>配置 DNS over HTTPS</h3><p>前文说到，为了实现 ECH，浏览器需要一些 DNS 扩展。考虑到操作系统一般没有除了获取 IP 地址（<code>getaddrinfo()</code>）之外的 DNS 相关 API，Firefox 另辟蹊径，通过其添加的 DNS over HTTPS 支持来实现自己需要的功能。因此，为了开启 ECH，需要先启用 DNS over HTTPS。</p><p>这并不复杂。在设置页面（<code>about:preferences</code>）搜索 DNS，点击「网络设置」一节的设置按钮，翻到最底下，就能看到 DNS over HTTPS 的设定。</p><figure class="image"><img src="https://assets.matters.news/embed/15bff704-2908-43e6-a28a-15a0a7e89dea.png" data-asset-id="15bff704-2908-43e6-a28a-15a0a7e89dea" referrerpolicy="no-referrer"><figcaption><span>开启 DNS over HTTPS</span></figcaption></figure><p>在这里，可以按照自己的喜好选择 DNS 服务提供商。如果对隐私有担忧，可以选择一些其它的 DoH 提供商，<a href="https://ungleich.ch/en-us/cms/blog/2019/09/10/turn-off-doh-firefox/" target="_blank">而不是那个位于美国的世界最大 MitM 公司</a>。</p><h3>开启 ECH</h3><p>这个比较简单。在 <code>about:config</code> 搜索条目 <code>network.security.esni.enabled</code>，将其设定改为 <code>true</code> 即可。</p><h3>测试</h3><p>配置完成后（可能需要重新启动浏览器），可以访问 <a href="https://www.cloudflare.com/ssl/encrypted-sni/" target="_blank">https://www.cloudflare.com/ssl/encrypted-sni/</a> ，按下 “Check My Browser” 按钮，就可以测试自己是否开启了 ECH (Encryped SNI) 了。</p><figure class="image"><img src="https://assets.matters.news/embed/639cab7e-8512-448f-bd00-a2a4c188393b.png" data-asset-id="639cab7e-8512-448f-bd00-a2a4c188393b" referrerpolicy="no-referrer"><figcaption><span>“Your browser encrypted the SNI...”</span></figcaption></figure><h2>常见问题</h2><h3>Cloudflare 提醒我 ESNI 未启用！</h3><p>可能是你的 DNS over HTTPS 并没有生效，Firefox 还在使用普通的 DNS 请求方式。这种情况下 ECH 无法工作。</p><p>你可以尝试按照 <a href="https://wiki.mozilla.org/Trusted_Recursive_Resolver" target="_blank">Mozilla Wiki</a> 的指示，在 <code>about:config</code> 中将 <code>network.trr.mode</code>设置为 <code>3</code>，即只使用 TRR（也就是我们的 DNS over HTTPS），强制 Firefox 使用 DoH，这样就能确保使用 ESNI 了。</p><h3>我按上条开启了 DoH only，但有的网站无法访问了！</h3><p>主要有两种情况：</p><ul><li>Firefox 默认不会接受通过 DoH 解析得来的本地地址结果（<a href="https://searchfox.org/mozilla-central/source/netwerk/dns/DNSPacket.cpp#569" target="_blank">[1]</a>, <a href="https://searchfox.org/mozilla-central/source/netwerk/dns/DNSPacket.cpp#864" target="_blank">[2]</a>）。对于这种情况，在 <code>about:config</code> 中将 <code>network.trr.allow-rfc1918</code> 设置为 <code>true</code> 即可。</li><li>如果你使用默认的 Cloudflare DNS，并且访问的是 <code>archive.is</code> 的话：包括 archive.is 在内的少数网站要求对其服务器 IP 进行查询的客户端<a href="https://twitter.com/archiveis/status/1018691421182791680" target="_blank">支持 ECS 拓展</a>，以提供最优化的解析结果，而 Cloudflare DNS 出于隐私原因<a href="https://developers.cloudflare.com/1.1.1.1/nitty-gritty-details#edns-client-subnet" target="_blank">故意不支持 ECS</a>。两边无法调和，于是使用 Cloudflare DNS 的用户就无法访问这些站点了（除非更换 DNS 服务器）。</li></ul><hr><blockquote>本文为 Blog 上原文稍作修改后的版本。所有修改均以 Blog 原文为准。由于 IPFS 的不可变性，Matters 的副本无法更新。欲查看原文，请参见 <a href="https://blog.outv.im/2020/firefox-doh-ech-esni/" target="_blank">Re:Linked</a>。</blockquote><blockquote>本文以 CC BY-NC-SA 4.0 协议发布。</blockquote><p><br></p>
