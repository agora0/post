---
layout: post
title: 如何在 2024 年初始化一个 Python 项目
date: 2024-10-03 14:27:28.000000000 +00:00
link: https://matters.news/@outloudvi/%E5%A6%82%E4%BD%95%E5%9C%A8-2024-%E5%B9%B4%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA-python-%E9%A1%B9%E7%9B%AE-bafybeid4cgbyzt36bye6bc4iczkvufi4v4pn5qtqirrg64zfy6si7so6uq
categories: matters
tags: blog
author: Out65
---

<p>（迁移到 11ty 之后的头一篇文章！）</p><p>最近 Python 的 breaking change 还挺多的：</p><ul><li><p>Python 3.11 或者 Python 3.12 的时候，许多发行版都根据 <a target="_blank" rel="noopener noreferrer nofollow" href="https://peps.python.org/pep-0668/">PEP 668</a> 配置了 EXTERNALLY-MANAGED，从而阻止用户使 pip 在非 virtualenv 中安装包。本来打算用 pip install 的用户也就会遇到一些 externally-managed-environment 之类的报错。</p></li><li><p>Python 3.12 在去年十月发布了，最大的改变大概就是<a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.python.org/3/whatsnew/3.12.html#summary-release-highlights">从标准库移除了 distutils</a> 包。许多在打包流程中用到 distutils 的开发者或许也遇到了一些问题。</p></li></ul><p>跟这些都无关，我在维护<a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/outloudvi/mw2fcitx">某个项目</a>的某一天，突然灵光一闪，<a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Eureka_(word)"><strong>Eureka!</strong></a>，于是向天空大吼一声：我受够 <a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a> 啦！然后就把项目迁移到了使用 <a target="_blank" rel="noopener noreferrer nofollow" href="https://python-poetry.org/">Poetry</a> 构建系统，然后就有了此文。</p><h2>为什么迁移？</h2><ul><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a> 太难写，现在这个 <a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a> 甚至还是从 youtube-dl 项目抄来的</p></li><li><p>setuptool 不自带 virtualenv，建立开发环境很麻烦</p></li><li><p>在 Python 项目中实现<a target="_blank" rel="noopener noreferrer nofollow" href="https://packaging.python.org/en/latest/guides/modernize-setup-py-project/">四个现代化</a></p><ul><li><p>现代化配置系统 (no more <a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a>)</p></li><li><p>现代化配置语言 (toml)</p></li><li><p>现代化打包工具 (poetry)</p></li><li><p>现代化打包程序 (<a target="_blank" rel="noopener noreferrer nofollow" href="https://packaging.python.org/en/latest/guides/tool-recommendations/#building-distributions">no more python </a><a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a><a target="_blank" rel="noopener noreferrer nofollow" href="https://packaging.python.org/en/latest/guides/tool-recommendations/#building-distributions"> sdist and python </a><a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a><a target="_blank" rel="noopener noreferrer nofollow" href="https://packaging.python.org/en/latest/guides/tool-recommendations/#building-distributions"> bdist_wheel</a>)</p></li></ul></li></ul><h3>为什么到 Poetry？</h3><p>其实 setuptools <a target="_blank" rel="noopener noreferrer nofollow" href="https://framapiaf.org/@fcodvpt/111540079686191842">依然是最受欢迎的打包工具</a>，但 Poetry 是第二名！Python 官方的打包文档就有<a target="_blank" rel="noopener noreferrer nofollow" href="https://packaging.python.org/en/latest/guides/tool-recommendations/#build-backends">推荐一些打包工具</a>。各位也可以选择其它自己喜欢的来使用，不过本文以 Poetry 为主。</p><p>Poetry 也可以<a target="_blank" rel="noopener noreferrer nofollow" href="https://python-poetry.org/docs/basic-usage/#operating-modes">只作为依赖管理工具</a>，配置方法是在 [tool.poetry] 设置 package-mode=false。</p><h2>步骤</h2><h3>写一个 pyproject.toml</h3><p>在新时代 Python 打包系统中，各种配置都放在 pyproject.toml。无论是包的信息、依赖的信息，还有 yapf、pylint、pytest 等各种各样工具的信息都在这里了。</p><p><a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a> 和依赖信息都可以参考<a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/outloudvi/mw2fcitx/blob/f059e9fd244b6f232f38d63a9c660da43c8f9253/pyproject.toml">这个例子</a>搬进 pyproject.toml。如果是迁移一个已经有 <a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a> 的项目，这一步大概就是最复杂的一步。</p><h3>环境配置和打包</h3><ul><li><p>poetry install 会初始化项目配置和安装依赖。</p></li><li><p>poetry build 会在 dist 文件夹中生成 sdist 及 wheel 打包结果。</p></li><li><p>poetry shell 可以启动利用环境内 Python 的 shell，大概相当于 pipenv shell。</p></li><li><p>poetry run 可以使用利用环境内 Python 的 shell 执行命令，大概相当于 pipenv run。</p></li></ul><h3>在 pyproject.toml 加入其它工具的配置</h3><p>很多开发者（尤其是 JavaScript 开发者）都不喜欢项目根目录堆积着大量不同的配置文件，而 Python 生态就正在支持整合不同工具的配置到统一的文件中。许多 Python 工具都加入了读取 pyproject.toml 中配置的支持，例如：</p><ul><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/google/yapf?tab=readme-ov-file#excluding-files-from-formatting-yapfignore-or-pyprojecttoml">yapf</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://coverage.readthedocs.io/en/7.6.1/config.html#sample-file">coverage</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://pylint.readthedocs.io/en/stable/user_guide/usage/run.html#command-line-options">pylint</a></p></li></ul><h3>通过 GitHub Actions 利用可信发布 (Trusted Publishing) 发布到 PyPI</h3><p>（这点和 Poetry 倒没有什么关系。）</p><p>Python 包最后大多要发布到 PyPI。如果是托管在 GitHub 上的项目，PyPI <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/pypa/gh-action-pypi-publish">提供了一个 action</a> 来方便地把完成打包（并且放置在 dist/）的包发布到 PyPI。为了使用 Trusted Publishing 功能，也需要在 PyPI <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.pypi.org/trusted-publishers/adding-a-publisher/">配置发布来源</a>。</p><h2>成果</h2><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/outloudvi/mw2fcitx/blob/083259df8691905dd6cbe2f5364c940faffaf7e1/setup.py">迁移前</a>：</p><ul><li><p>各种配置分开：包元数据在 <a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a>、依赖在 Pipfile、格式化配置在 setup.cfg、linting 配置在 .pylintrc 等</p></li><li><p>构建命令是 python <a target="_blank" rel="noopener noreferrer nofollow" href="http://setup.py/">setup.py</a> sdist 等等</p></li><li><p>开发用 virtualenv 由 Pipenv 管理</p></li></ul><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/outloudvi/mw2fcitx/blob/f059e9fd244b6f232f38d63a9c660da43c8f9253/pyproject.toml">迁移以及若干迭代之后</a>：</p><ul><li><p>各种配置都写在 pyprojtect.toml：包元数据、依赖、格式化及单元测试工具配置</p></li><li><p>能够区分 dependencies 和 devDependencies</p></li><li><p>构建命令是 poetry build</p></li><li><p>开发用 virtualenv 也由 Poetry 管理</p></li><li><p>coverage 监测也有了</p></li></ul><hr><p>本文为 Blog 上原文稍作修改后的版本。所有修改均以 Blog 原文为准。由于 IPFS 的不可变性，Matters 的副本无法更新。欲查看原文，请参见 <a target="_blank" rel="noopener noreferrer nofollow" href="https://blog.outv.im/2024/start-a-python-project/">Re:Linked</a> 。</p>
